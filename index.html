<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>NovaSpazio ‚Äî PeopleFirst+ PMS (Demo)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#0a1120;
    --bg2:#0c1a31;
    --card:#0f1d32;
    --ink:#eaf4ff;
    --muted:#9fb5c2;
    --accent:#21d1c8;
    --accent2:#5ba7ff;
    --accent3:#8a6cff;
    --line:rgba(255,255,255,0.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink); font-family:Inter,Segoe UI,Arial;
    background:
      radial-gradient(1200px 600px at 80% -10%, #0b2342 0%, transparent 60%),
      radial-gradient(900px 600px at -20% 20%, #0b1c33 0%, transparent 60%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    min-height:100vh; padding:24px;
    
  height: 100vh;
  background-image: url('pic/backbaby2.jpeg'); /* Replace with your image path */
  background-size: cover; /* Makes it fill the page */
  background-position: center; /* Centers it */
  background-repeat: no-repeat; /* Avoids tiling */
 

  }
  /* Header */
  .header{display:flex;align-items:center;gap:16px;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:14px}
  .logo-wrap{width:48px;height:48px}
  h1{font-size:20px;margin:0;letter-spacing:.2px}
  .tag{font-size:12px;color:var(--muted)}
  /* Container */
  .panel{
    display:none; /* Hide dashboard initially */
    border:1px solid var(--line); border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.35);
  }
  .subhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .hint{font-size:12px;color:var(--muted)}
  /* Grid */
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-top:12px}
  .tile{
    position:relative; background:var(--card); border:1px solid var(--line);
    border-radius:12px; padding:12px; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease;
  }
  .tile:hover{transform:translateY(-2px); box-shadow:0 12px 36px rgba(0,0,0,.35)}
  .avatar{display:flex;align-items:center;justify-content:center;margin-bottom:10px}
  .name{font-weight:700}
  .role{font-size:12px;color:var(--muted);line-height:1.3;margin-top:2px}
  .pill{
    position:absolute; top:10px; right:10px; font-size:11px;
    background:linear-gradient(90deg, rgba(33,209,200,.18), rgba(91,167,255,.18));
    border:1px solid rgba(255,255,255,.08); padding:4px 8px; border-radius:999px; color:#d9f8ff;
  }
  /* Buttons */
  .btn{background:linear-gradient(90deg, var(--accent) , var(--accent2)); color:#001; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700}
  .btn.secondary{background:transparent;color:var(--ink);border:1px solid var(--line)}
  .btn.flat{background:transparent;border:none;color:var(--accent)}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(1,5,16,.55);backdrop-filter:blur(4px)}
  .card{background:var(--card); width:840px; max-width:95%; border-radius:14px; padding:18px; border:1px solid var(--line); box-shadow:0 24px 64px rgba(0,0,0,.5)}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .objective{background:#0a1830;border:1px solid var(--line); padding:12px; border-radius:10px;margin-bottom:10px}
  .objective h3{margin:0 0 6px 0;font-size:16px}
  .small{font-size:12px;color:var(--muted)}
  .nav{display:flex;justify-content:space-between;margin-top:12px}
  canvas{background:#04101c;border-radius:10px;margin-top:8px;border:1px solid var(--line)}
  .divider{height:1px;background:var(--line);margin:10px 0}
  /* Avatar SVG seats */
  .svg-avatar{width:70px;height:70px}
  .footnote{font-size:11px;color:var(--muted);margin-top:10px}
  /* Landing */
  .landing {
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    height:100vh;
    text-align:center;
  }
  #bar {
  width: 100%;    /* Make the canvas take up 100% of its container width */
  height: 100%;   /* Adjust the height based on the container */
  max-width: 100%; /* Prevent the canvas from exceeding its container width */
  max-height: 200px; /* Set a maximum height to prevent the chart from growing too tall */
}
  @media (max-width:960px){ .grid{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>

  <!-- Landing
  <div class="landing" id="landing">
    <div class="header">
      <div class="brand">
      
        <div class="logo-wrap" aria-hidden="true">
          <svg viewBox="0 0 64 64" class="svg-logo">
            <defs>
              <linearGradient id="g" x1="0" x2="1">
                <stop offset="0" stop-color="#21d1c8"/>
                <stop offset="1" stop-color="#5ba7ff"/>
              </linearGradient>
            </defs>
            <circle cx="32" cy="32" r="28" fill="url(#g)" opacity=".12"/>
            <circle cx="32" cy="32" r="20" fill="none" stroke="url(#g)" stroke-width="2" opacity=".9"/>
            <path d="M10,34 C22,28 42,28 54,34" fill="none" stroke="#8a6cff" stroke-width="2" opacity=".9"/>
            <circle cx="44" cy="31" r="3" fill="#8a6cff"/>
          
            <path d="M20 44 L20 20 L22 20 L42 44 L42 20 L44 20 L44 44 L42 44 L22 22 L22 44 Z" fill="#dffaff"/>
          </svg>
        </div>
        <div>
          <h1>NovaSpazio ‚Äî PeopleFirst+ PMS</h1>
          <div class="tag">Inspired by Telespazio‚Äôs best-practice PMS ‚Ä¢ Telecom-grade performance & development</div>
        </div>
      </div>
      <button class="btn" id="startBtn">Start Appraisals</button>
    </div>
  </div> -->

<!-- HR Landing Page -->
<div id="landing" style="
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  background: url('your-background-image.jpg') center/cover no-repeat;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  padding: 40px 20px;
  position: relative;
  overflow: hidden;
">

  <!-- Decorative Corners -->
  <div style="position: absolute; top: 10px; left: 10px; font-size: 2rem; opacity: 0.1;">üë•</div>
  <div style="position: absolute; top: 10px; right: 10px; font-size: 2rem; opacity: 0.1;">üìä</div>
  <div style="position: absolute; bottom: 10px; left: 10px; font-size: 2rem; opacity: 0.1;">üíº</div>
  <div style="position: absolute; bottom: 10px; right: 10px; font-size: 2rem; opacity: 0.1;">üèÜ</div>

  <!-- Logo -->
  <div style="animation: fadeIn 1.2s ease; margin-top: 30px;">
    <svg viewBox="0 0 64 64" style="width: 110px; height: 110px;">
      <defs>
        <linearGradient id="g" x1="0" x2="1">
          <stop offset="0" stop-color="#21d1c8"/>
          <stop offset="1" stop-color="#5ba7ff"/>
        </linearGradient>
      </defs>
      <circle cx="32" cy="32" r="28" fill="url(#g)" opacity=".12"/>
      <circle cx="32" cy="32" r="20" fill="none" stroke="url(#g)" stroke-width="2" opacity=".9"/>
      <path d="M10,34 C22,28 42,28 54,34" fill="none" stroke="#8a6cff" stroke-width="2" opacity=".9"/>
      <circle cx="44" cy="31" r="3" fill="#8a6cff"/>
      <path d="M20 44 L20 20 L22 20 L42 44 L42 20 L44 20 L44 44 L42 44 L22 22 L22 44 Z" fill="#dffaff"/>
    </svg>
  </div>

  <!-- Title -->
  <h1 style="font-size: 2rem; margin: 15px 0 8px; animation: fadeInUp 1.5s ease;">
    NovaSpazio ‚Äî PeopleFirst+ PMS
  </h1>
  <p style="color: #b5d1e8; font-size: 1rem; max-width: 500px; animation: fadeInUp 1.8s ease;">
    The Future of Performance Management ‚Äî Data-driven, people-first, and designed for telecom-grade excellence.
  </p>

  <!-- Call-to-Action -->
  <button id="startBtn" style="
    margin-top: 20px;
    background: linear-gradient(135deg, #21d1c8, #5ba7ff);
    border: none;
    padding: 12px 30px;
    font-size: 1rem;
    border-radius: 40px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 15px rgba(33,209,200,0.5);
    transition: all 0.3s ease;
    animation: fadeInUp 2s ease, pulse 2s infinite;
  "
    onmouseover="this.style.transform='scale(1.08)'; this.style.boxShadow='0 0 25px rgba(91,167,255,0.7)'"
    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 0 15px rgba(33,209,200,0.5)'"
  >Start Appraisals</button>

  <!-- Details Section -->
  <div style="display: flex; gap: 20px; margin-top: 40px; animation: fadeInUp 2.3s ease; flex-wrap: wrap; justify-content: center;">
    <div style="max-width: 180px;">
      <div style="font-size: 1.8rem;">üìà</div>
      <div style="font-weight: bold; margin: 8px 0;">Smart Analytics</div>
      <div style="color: #d0e7f5; font-size: 0.85rem;">Insights that drive better decisions for your team.</div>
    </div>
    <div style="max-width: 180px;">
      <div style="font-size: 1.8rem;">‚ö°</div>
      <div style="font-weight: bold; margin: 8px 0;">Fast & Intuitive</div>
      <div style="color: #d0e7f5; font-size: 0.85rem;">A sleek, manager-friendly interface you‚Äôll love using.</div>
    </div>
    <div style="max-width: 180px;">
      <div style="font-size: 1.8rem;">ü§ù</div>
      <div style="font-weight: bold; margin: 8px 0;">People-First</div>
      <div style="color: #d0e7f5; font-size: 0.85rem;">Empowering employees and leaders alike.</div>
    </div>
  </div>

</div>

<!-- Animations -->
<style>
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes pulse {
  0% { box-shadow: 0 0 15px rgba(33,209,200,0.5); }
  50% { box-shadow: 0 0 25px rgba(91,167,255,0.8); }
  100% { box-shadow: 0 0 15px rgba(33,209,200,0.5); }
}
</style>





  <!-- Dashboard -->
  <div class="panel" id="dashboard">
    <div class="subhead">
      <div>
        <strong>Manager:</strong> Senior Manager (You) ‚Ä¢ <strong>Cycle:</strong> FY 2023‚Äì24
        <div class="hint">Select an employee to begin appraisal. Each flow takes ~2‚Äì4 minutes.</div>
      </div>
      <button class="btn secondary" id="resetBtn" title="Clear saved demo results">Reset Results</button>
    </div>
    <div class="grid" id="grid"></div>
    <div class="footnote">Tip: After you finish a review, the score bubble on the tile updates. Re-open to revisit.</div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Appraisal modal">
    <div class="card">
      <div id="modalContent"></div>
      <div class="nav">
        <button class="btn secondary" id="backBtn">Back</button>
        <button class="btn" id="nextBtn">Next</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Show dashboard on Start ---------- */
document.getElementById('startBtn').onclick = () => {
  document.getElementById('landing').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
};

/* ---------- Rest of your JS from original code ---------- */
const GENDER = {M:'male', F:'female'};

const employees = [
  {id:1, name:"Akhil Juneja", gender:GENDER.M, role:"Network Operations Engineer" , img : "", objectives:[
    {title:"Reduce MTTR by 20%", weight:30, desc:"P2 incidents across assigned clusters"},
    {title:"Implement 2 automations", weight:25, desc:"Reduce manual ticket ops by 25%"},
    {title:"Maintain uptime ‚â• 99.8%", weight:25, desc:"Core + access nodes"},
    {title:"5 RCA documents shared", weight:20, desc:"Knowledge base improvements"}
  ]},
  {id:2, name:"Audhip Chowdhury", gender:GENDER.M, role:"RF Optimization Engineer", img : "pic/", objectives:[
    {title:"Avg throughput +10%", weight:30},
    {title:"Drop call rate ‚Üì 15%", weight:25},
    {title:"Top-10 cells optimized", weight:25},
    {title:"2 KT sessions per qtr", weight:20}
  ]},
  {id:3, name:"Parth", gender:GENDER.M, role:"Field Technician (Site Ops)",img : "pic/Parth_Yadav.png",objectives:[
    {title:"On-site resolution ‚â• 85%", weight:30},
    {title:"Safety & SOP compliance", weight:20},
    {title:"Visit CSAT ‚â• 4.5/5", weight:30},
    {title:"Repeat visits ‚Üì 15%", weight:20}
  ]},
  {id:4, name:"Swapnil", gender:GENDER.M, role:"Backhaul / Satellite Engineer", objectives:[
    {title:"Backhaul reliability ‚â• 99.9%", weight:30},
    {title:"Latency improvement (ms)", weight:25},
    {title:"Redundancy plan deployed", weight:25},
    {title:"Team training x3", weight:20}
  ]},
  {id:5, name:"Ananya", gender:GENDER.F, role:"Product Manager ‚Äî Digital", objectives:[
    {title:"MAU growth +15%", weight:30},
    {title:"Roadmap on-time ‚â• 90%", weight:25},
    {title:"Feature adoption ‚â• target", weight:25},
    {title:"3 A/B tests completed", weight:20}
  ]},
  {id:6, name:"Apurva", gender:GENDER.F, role:"Senior Backend Engineer", img : "pic/apurwa.HEIC", objectives:[
    {title:"System availability 99.95%", weight:30},
    {title:"Microservices deployed", weight:25},
    {title:"Latency ‚Üì 20%", weight:25},
    {title:"Code quality ‚Üë (Sonar)", weight:20}
  ]},
  {id:7, name:"Gayatri Devrakonda", gender:GENDER.F, role:"Customer Experience Analyst", img : "pic/gayatri_devarakonda.jpg",objectives:[
    {title:"NPS +5 points", weight:30},
    {title:"Complaints ‚Üì 15%", weight:25},
    {title:"FCR (first contact resolution)", weight:25},
    {title:"Insights ‚Üí 3 product changes", weight:20}
  ]},
  {id:8, name:"Pranali Hole", gender:GENDER.F, role:"Sales Account Manager (Enterprise)",img : "pic/Pranali_Hole.jpg", objectives:[
    {title:"Net-new revenue target", weight:35},
    {title:"Top-client retention", weight:25},
    {title:"Cross-sell wins", weight:20},
    {title:"Sales cycle ‚Üì 10%", weight:20}
  ]},
  {id:9, name:"Sonal", gender:GENDER.F, role:"Data Analyst ‚Äî Network Insights", objectives:[
    {title:"Models ‚Üí actionable alerts", weight:30},
    {title:"Anomaly detection time ‚Üì", weight:25},
    {title:"Dashboard adoption", weight:25},
    {title:"Train engineers on tools", weight:20}
  ]},
  {id:10, name:"Tejasvita", gender:GENDER.F, role:"HR Business Partner (BU)", objectives:[
    {title:"Time-to-hire ‚Üì 20%", weight:30},
    {title:"Attrition in BU ‚Üì 3pp", weight:25},
    {title:"L&D uptake ‚â• 80%", weight:25},
    {title:"Manager enablement x4", weight:20}
  ]},
];

/* ---------- UI: build grid with SVG avatars ---------- */
const grid = document.getElementById('grid');
function avatarSVG(name, gender){
  const initials = name.split(' ').map(s=>s[0]).slice(0,2).join('');
  // color theme by gender
  const ring = gender===GENDER.M ? '#5ba7ff' : '#21d1c8';
  const fill = gender===GENDER.M ? 'rgba(91,167,255,.15)' : 'rgba(33,209,200,.15)';
  const icon = gender===GENDER.M ? 'M34 26 a6 6 0 1 1 -12 0 a6 6 0 1 1 12 0 M22 44 q8 -8 16 0 v4 h-16 z'
                                 : 'M32 24 a6 6 0 1 1 0 12 a6 6 0 1 1 0 -12 M22 44 q10 -10 20 0 v4 h-20 z';
  return `
  <svg viewBox="0 0 64 64" class="svg-avatar" aria-hidden="true">
    <defs><linearGradient id="gA" x1="0" x2="1"><stop offset="0" stop-color="#21d1c8"/><stop offset="1" stop-color="#5ba7ff"/></linearGradient></defs>
    <circle cx="32" cy="32" r="30" fill="${fill}" stroke="url(#gA)" stroke-width="1.5"/>
    <path d="${icon}" fill="${ring}" opacity=".9"/>
    <circle cx="48" cy="14" r="5" fill="#8a6cff" opacity=".9"/>
    <text x="32" y="58" text-anchor="middle" font-size="12" fill="#eaf4ff" font-weight="700">${initials}</text>
  </svg>`;
}

// function makeTile(emp){
//   const tile = document.createElement('div'); tile.className='tile'; tile.id = `tile-${emp.id}`;
//   tile.innerHTML = `
//     <div class="pill" id="pill-${emp.id}">Not Reviewed</div>
//     <div style="
//   display: flex;
//   justify-content: center;
//   align-items: center;
//   width: 70px;
//   height: 70px;
//   border-radius: 50%;
//   overflow: hidden;
  
 
// ">
//   <img src="${emp.img}" alt="${emp.name}" style="width: 100%; height: 100%; object-fit: cover;" />
// </div>
//     <div class="name">${emp.name}</div>
//     <div class="role">${emp.role}</div>
//   `;
//   tile.onclick = () => openModal(emp.id);
//   return tile;
// }

// function makeTile(emp){
//   const tile = document.createElement('div'); 
//   tile.className = 'tile'; 
//   tile.id = `tile-${emp.id}`;

//   tile.innerHTML = `
//     <div class="pill" id="pill-${emp.id}">Not Reviewed</div>

//     <!-- Keep the .avatar wrapper: it centers content -->
//     <div class="avatar">
//       <div style="
//         width:70px; height:70px; border-radius:50%;
//         overflow:hidden; 
//         border:1px solid rgba(255,255,255,0.12);
//       ">
//         <img src="${emp.img}" alt="${emp.name}" 
//              style="width:100%; height:100%; object-fit:cover; display:block; object-position:center;" />
//       </div>
//     </div>

//     <div class="name" style="text-align:center;">${emp.name}</div>
//     <div class="role" style="text-align:center;">${emp.role}</div>
//   `;

//   tile.onclick = () => openModal(emp.id);
//   return tile;
// }


function makeTile(emp) {
  const tile = document.createElement('div');
  tile.className = 'tile';
  tile.id = `tile-${emp.id}`;

  tile.innerHTML = `
    <div class="avatar" style="position: relative; display: flex; justify-content: center; align-items: center;">

      <!-- Outer gradient border -->
      <div style="
        position: relative;
        width: 76px;
        height: 76px;
        border-radius: 50%;
        padding: 3px;
        background: linear-gradient(135deg, #21d1c8, #5ba7ff);
        display: flex;
        align-items: center;
        justify-content: center;
      ">
        <!-- Image circle -->
        <div style="
          width: 70px;
          height: 70px;
          border-radius: 50%;
          overflow: hidden;
        ">
          <img src="${emp.img}" alt="${emp.name}"
               style="width: 100%; height: 100%; object-fit: cover; display: block; object-position: center;" />
        </div>

        <!-- Status dot -->
        <div style="
          position: absolute;
          top: 14px;
          right: 6px;
          width: 11px;
          height: 11px;
          border-radius: 50%;
          background-color: #8a6cff;
          
        "></div>
      </div>

      <!-- Pill label -->
      <div class="pill" id="pill-${emp.id}"  style="
        position: absolute;
        top: -2px;
        right: -17px;
        background-color: rgba(33,209,200,0.15);
        border-radius: 20px;
        padding: 2px 10px;
        font-size: 12px;
        color: white;
        border: 1px solid #21d1c8;
      ">Not Reviewed</div>  
    </div>

    <div class="name" style="text-align: center;">${emp.name}</div>
    <div class="role" style="text-align: center;">${emp.role}</div>
  `;

  tile.onclick = () => openModal(emp.id);
  return tile;
}



function initGrid(){
  employees.forEach(emp => grid.appendChild(makeTile(emp)));
}
initGrid();

/* ---------- Modal flow ---------- */
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const backBtn = document.getElementById('backBtn');
const nextBtn = document.getElementById('nextBtn');

let currentEmp = null;
let stepIndex = 0;
let responses = {}; // { empId: { objRatings:[], competencies:[] } }
let reviewCompleted = {};

function openModal(empId){
  currentEmp = employees.find(e => e.id === empId);
  stepIndex = 0;
  console.log(`Opening modal for ${currentEmp.name} (ID: ${empId}) with ${reviewCompleted[empId]} review.`);
  // If review is already completed, directly show the result
  if (reviewCompleted[empId]) {
    modal.style.display = 'flex';
    renderResult();
  } else {
    responses[currentEmp.id] = { objRatings: [], competencies: [] };
    modal.style.display = 'flex';
    renderStep();
  }
}


function closeModal(){
  modal.style.display='none';
}

backBtn.onclick = ()=>{
  if(stepIndex===0){ closeModal(); return; }
  if(stepIndex <= currentEmp.objectives.length){
    stepIndex--;
    if(stepIndex < currentEmp.objectives.length) responses[currentEmp.id].objRatings.pop();
  }else{
    stepIndex--;
  }
  renderStep();
};

nextBtn.onclick = ()=>{
  if(stepIndex < currentEmp.objectives.length){
    const r = document.querySelector('input[name="r"]:checked');
    if(!r){ alert('Select a rating'); return; }
    responses[currentEmp.id].objRatings.push(parseFloat(r.value));
    stepIndex++;
    renderStep();
  } else if(stepIndex === currentEmp.objectives.length){
    const comps = ['Customer Orientation','Collaboration','Innovation','Execution','Communication'];
    const pts=[];
    for(let i=0;i<comps.length;i++){
      const v = document.querySelector(`input[name="c${i}"]:checked`);
      if(!v){ alert('Rate all competencies'); return; }
      pts.push(parseInt(v.value));
    }
    responses[currentEmp.id].competencies = pts;
    stepIndex++;
    renderStep();
  }
};

/* ---------- Steps renderer ---------- */
function renderStep() {
  const emp = currentEmp;
  modalContent.innerHTML = '';

  // Intro card
  if (stepIndex === 0) {
    modalContent.innerHTML = `
      <div class="row" style="align-items:center;gap:16px">
        <div style="
          width: 70px;
          height: 70px;
          border-radius: 50%;
          overflow: hidden;
        ">
          <img src="${emp.img}" alt="${emp.name}"
               style="width: 100%; height: 100%; object-fit: cover; display: block; object-position: center;" />
        </div>
        <div>
          <h2 style="margin:0">${emp.name}</h2>
          <div class="small">${emp.role}</div>
          <div class="divider"></div>
          <div class="small">You‚Äôll review ${emp.objectives.length} objectives and 5 competencies.<br/>Scoring: Not (0) ‚Ä¢ Achieved (100%) ‚Ä¢ Exceeded (125%). Competencies can add up to +5%.</div>
        </div>
      </div>
      <div class="objective">
        <h3>Objective 1 of ${emp.objectives.length}</h3>
        <p class="small"><strong>${emp.objectives[0].title}</strong> <span style="color:var(--muted)"> (Weight ${emp.objectives[0].weight}%)</span><br>${emp.objectives[0].desc || ''}</p>
        <label><input type="radio" name="r" value="0"> Not achieved</label><br>
        <label><input type="radio" name="r" value="1"> Achieved</label><br>
        <label><input type="radio" name="r" value="1.25"> Exceeded</label>
      </div>
    `;
    nextBtn.textContent = 'Next';
    nextBtn.style.display = 'inline-block'; // Make sure it's visible on first step
    return;
  }

  // Objectives pages
  if (stepIndex > 0 && stepIndex < emp.objectives.length) {
    const i = stepIndex;
    const obj = emp.objectives[i];
    modalContent.innerHTML = `
      <div class="objective">
        <h3>Objective ${i + 1} of ${emp.objectives.length}</h3>
        <p class="small"><strong>${obj.title}</strong> <span style="color:var(--muted)"> (Weight ${obj.weight}%)</span><br>${obj.desc || ''}</p>
        <label><input type="radio" name="r" value="0"> Not achieved</label><br>
        <label><input type="radio" name="r" value="1"> Achieved</label><br>
        <label><input type="radio" name="r" value="1.25"> Exceeded</label>
      </div>
    `;
    nextBtn.textContent = (i === emp.objectives.length - 1) ? 'Go to Competencies' : 'Next';
    nextBtn.style.display = 'inline-block'; // Ensure it's visible during objective steps
    return;
  }

  // Competencies page
  if (stepIndex === emp.objectives.length) {
    const comps = ['Customer Orientation', 'Collaboration', 'Innovation', 'Execution', 'Communication'];
    const cblock = document.createElement('div');
    cblock.className = 'objective';
    cblock.innerHTML = `<h3>Competencies</h3><p class="small">Rate the following (0 = To be improved, 1 = Standard, 2 = Outstanding)</p>`;
    comps.forEach((c, i) => {
      cblock.insertAdjacentHTML('beforeend', `
        <div style="margin:8px 0"><strong>${c}</strong><br/>
          <label><input type="radio" name="c${i}" value="0"> To be improved</label>
          <label style="margin-left:8px"><input type="radio" name="c${i}" value="1"> Standard</label>
          <label style="margin-left:8px"><input type="radio" name="c${i}" value="2"> Outstanding</label>
        </div>
      `);
    });
    modalContent.appendChild(cblock);
    nextBtn.textContent = 'Calculate';
    nextBtn.style.display = 'inline-block'; // Ensure it's visible on competencies step
    return;
  }

  // Summary page (final step after the review is complete)
  const result = computeScore(emp.id);
  modalContent.innerHTML = `
    <div class="row" style="align-items:center;gap:16px">
      <div>${avatarSVG(emp.name, emp.gender)}</div>
      <div>
        <h2 style="margin:0">${emp.name}</h2>
        <div class="small">${emp.role}</div>
      </div>
    </div>
    <div class="divider"></div>
    <p style="font-size:20px;font-weight:800;margin:6px 0">${result.finalPercent.toFixed(1)}% ‚Äî ${result.band}</p>
    <div class="small">Objectives: ${result.objectivesPercent.toFixed(1)}% ‚Ä¢ Competency boost: ${(result.finalPercent - result.objectivesPercent).toFixed(1)}%</div>
    <canvas id="bar" width="780" height="170" aria-label="Score chart"></canvas>
    <div class="objective">
      <h3>Suggested IDP</h3>
      <ul style="margin:6px 0 0 18px">
        <li>${result.idp[0]}</li>
        <li>${result.idp[1]}</li>
      </ul>
    </div>
    <div class="row">
      <button class="btn" id="saveBtn">Save Appraisal</button>
      <button class="btn secondary" id="closeBtn">Close</button>
    </div>
  `;
  document.getElementById('saveBtn').onclick = () => saveAppraisal(emp.id, result);
  document.getElementById('closeBtn').onclick = closeModal;
  nextBtn.textContent = 'Next';
  nextBtn.style.display = 'none'; // Hide next button on summary page after final step
  drawChart(result);  
  reviewCompleted[emp.id] = true;  // Mark this review as completed
}

function renderResult() {
  const emp = currentEmp;
  const result = computeScore(emp.id);
  modalContent.innerHTML = `
    <div class="row" style="align-items:center;gap:16px">
      <div>${avatarSVG(emp.name, emp.gender)}</div>
      <div>
        <h2 style="margin:0">${emp.name}</h2>
        <div class="small">${emp.role}</div>
      </div>
    </div>
    <div class="divider"></div>
    <p style="font-size:20px;font-weight:800;margin:6px 0">${result.finalPercent.toFixed(1)}% ‚Äî ${result.band}</p>
    <div class="small">Objectives: ${result.objectivesPercent.toFixed(1)}% ‚Ä¢ Competency boost: ${(result.finalPercent - result.objectivesPercent).toFixed(1)}%</div>
    <canvas id="bar" width="780" height="170" aria-label="Score chart"></canvas>
    <div class="objective">
      <h3>Suggested IDP</h3>
      <ul style="margin:6px 0 0 18px">
        <li>${result.idp[0]}</li>
        <li>${result.idp[1]}</li>
      </ul>
    </div>
    
  `;
  // document.getElementById('closeBtn').onclick = closeModal;
  drawChart(result);
}
/* ---------- Scoring ---------- */
function computeScore(empId){
  const emp = employees.find(e=>e.id===empId);
  const resp = responses[empId];
  const weights = emp.objectives.map(o=>o.weight);
  // Objectives score in percent (weights sum to 100)
  let objScore=0;
  for(let i=0;i<weights.length;i++){ objScore += weights[i] * (resp.objRatings[i] || 0); }
  let objectivesPercent = objScore;

  // Competency modifier (up to +5%)
  const compSum = resp.competencies.reduce((a,b)=>a+b,0);
  const maxComp = 2 * resp.competencies.length;
  const compModifier = 1 + 0.05 * (compSum / maxComp);
  const finalPercent = objectivesPercent * compModifier;

  // Banding
  let band='Meets expectations';
  if(finalPercent>=110) band='Exceptional';
  else if(finalPercent>=90) band='Exceeds';
  else if(finalPercent<70) band='Needs Improvement';

  // Simple IDP logic
  const idpGood = ['Advanced role certification (16‚Äì20 hrs)', 'Mentor pairing (12 weeks)'];
  const idpImprove = ['Targeted skills booster (20‚Äì25 hrs)', 'Monthly check-ins with skill practice'];
  const idp = finalPercent<90 ? idpImprove : idpGood;

  return {objectivesPercent, finalPercent, band, idp, compSum};
}

/* ---------- Chart ---------- */
function drawChart(result){
  const c = document.getElementById('bar'); if(!c) return;
  const ctx = c.getContext('2d');

  // Get the current width and height of the canvas
  const canvasWidth = c.offsetWidth;
  const canvasHeight = c.offsetHeight;

  // Clear any existing content
  ctx.clearRect(0, 0, canvasWidth, canvasHeight);
  const labels = ['Objectives','Competency Boost','Final'];
  const values = [result.objectivesPercent, Math.max(result.finalPercent - result.objectivesPercent,0), result.finalPercent];

  const x = 24, y0 = 22, h = 22, gap = 28, scale = 2.6;
  for(let i=0;i<3;i++){
    ctx.fillStyle = i===2 ? '#21d1c8' : (i===0 ? '#5ba7ff' : '#8a6cff');
    ctx.fillRect(x, y0 + i*(h+gap), values[i]*scale, h);
    ctx.fillStyle = '#cfe9ff';
    ctx.font = '12px system-ui';
    ctx.fillText(`${labels[i]} ‚Äî ${values[i].toFixed(1)}%`, x + values[i]*scale + 8, y0 + i*(h+gap) + h - 6);
  }
  // baseline
  ctx.strokeStyle = 'rgba(255,255,255,.12)';
  ctx.beginPath(); ctx.moveTo(x, 8); ctx.lineTo(x, 128); ctx.stroke();
}

/* ---------- Persistence ---------- */
function saveAppraisal(empId, result){
  const key = 'novaspazio_pms_results';
  const store = JSON.parse(localStorage.getItem(key) || '[]');
  // replace existing entry for empId
  const i = store.findIndex(r=>r.empId===empId);
  const item = {empId, result, timestamp:new Date().toISOString()};
  if(i>=0) store[i] = item; else store.push(item);
  localStorage.setItem(key, JSON.stringify(store));
  document.getElementById('pill-'+empId).textContent = result.finalPercent.toFixed(1)+'%';
  alert('Saved');
  closeModal();
}

document.getElementById('resetBtn').onclick = ()=>{
  localStorage.removeItem('novaspazio_pms_results');
  employees.forEach(e=>{ const pill = document.getElementById('pill-'+e.id); if(pill) pill.textContent='Not Reviewed'; });
  alert('All saved demo results cleared.');
};
</script>
</body>
</html>
